  <!-- 1) Antes de tu script principal -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.4"></script>

  <!-- 2) Sección de gráficos con datos simulados -->
  <h1 style="margin-top:2rem; text-align:center; color: var(--primary-dark);">
    Gráficos con datos simulados
  </h1>
  <section class="charts">
    <!-- … tus primeros 5 gráficos … -->

    <!-- 6) Heatmap ORP por hora y sistema -->
    <div class="chart-container">
      <h3>6. Heatmap ORP por hora y sistema</h3>
      <p style="font-size:0.9rem; color:#555;">
        ORP promedio por hora para cada sistema.
      </p>
      <canvas id="heatmapORP"></canvas>
    </div>
  </section>

  <!-- 3) Ahora tu script principal -->
  <script>
    // Registrar plugin (necesario en Chart.js v4+)
    Chart.register(
      ChartMatrixController,
      ChartMatrixElement,
      ChartColorScale,
      ChartLinearScale
    );

    // Datos simulados (mismo que antes)
    const sistemas = ['CIIDIR','San Lorenzo','Sistema X'];
    const ahora = Date.now();
    const simData = sistemas.map(name=>({
      name,
      readings: Array.from({length:50},(_,i)=>({
        time: ahora - (50-i)*3600e3,
        value: Math.random()*200 - 50
      }))
    }));

    // … aquí van tus gráficos 1–5 …

    // 6. Heatmap ORP
    // Preparamos los datos de matrix
    const matrixData = [];
    simData.forEach((s,i)=>{
      const porHora = {};
      s.readings.forEach(r=>{
        const h = new Date(r.time).getHours();
        porHora[h] = porHora[h]||[];
        porHora[h].push(r.value);
      });
      Object.entries(porHora).forEach(([h, arr])=>{
        matrixData.push({
          x: Number(h),
          y: i,
          v: arr.reduce((a,b)=>a+b,0)/arr.length
        });
      });
    });

    // Creamos el gráfico
    new Chart(
      document.getElementById('heatmapORP').getContext('2d'),
      {
        type: 'matrix',
        data: {
          datasets:[{
            label: 'ORP promedio',
            data: matrixData,
            backgroundColor: ctx => {
              // escala de color sencilla
              const v = ctx.dataset.data[ctx.dataIndex].v;
              const norm = (v + 50) / 250; 
              return `rgba(103,0,54,${norm})`;
            },
            width: ({chart}) => (chart.chartArea || {}).width / 24 - 1,
            height: ({chart})=> (chart.chartArea || {}).height / sistemas.length - 1
          }]
        },
        options: {
          scales:{
            x:{
              title:{ display:true, text:'Hora del día' },
              type:'linear',
              min:0,
              max:23,
              ticks:{ stepSize:1 }
            },
            y:{
              title:{ display:true, text:'Sistema' },
              type:'linear',
              min:-0.5,
              max:sistemas.length-0.5,
              ticks:{
                callback: idx => sistemas[idx]
              }
            }
          },
          plugins:{
            tooltip:{
              callbacks:{
                label(ctx){
                  const {x,y,v} = ctx.raw;
                  return `${sistemas[y]} — ${x}h: ${v.toFixed(1)} mV`;
                }
              }
            },
            legend:{ display:false }
          }
        }
      }
    );
  </script>
